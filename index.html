<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>è³“æœéŠæˆ²</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-x: hidden;
        }
        
        .screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .bg-purple { background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%); }
        .bg-blue { background: linear-gradient(135deg, #3b82f6 0%, #4f46e5 100%); }
        .bg-green { background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%); }
        
        .card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
        }
        
        .card-game {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 1.5rem;
            max-width: 900px;
            width: 100%;
        }
        
        h1 {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        
        .btn {
            width: 100%;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        
        .btn-green { background: #10b981; color: white; }
        .btn-green:hover { background: #059669; }
        
        .btn-red { background: #ef4444; color: white; }
        .btn-red:hover { background: #dc2626; }
        
        .btn-purple { background: #a855f7; color: white; }
        .btn-purple:hover { background: #9333ea; }
        
        .btn-orange { background: #f97316; color: white; }
        .btn-orange:hover { background: #ea580c; }
        
        .btn-gray { background: #6b7280; color: white; }
        .btn-gray:hover { background: #4b5563; }
        
        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 3px solid #d1d5db;
            border-radius: 12px;
            font-size: 1.25rem;
            text-align: center;
            font-weight: bold;
        }
        
        .input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .label {
            display: block;
            color: #374151;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .space-y-4 > * + * {
            margin-top: 1rem;
        }
        
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .bingo-cell {
            aspect-ratio: 1;
            border: 3px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .bingo-cell:active { transform: scale(0.95); }
        
        .bingo-cell.marked {
            background: linear-gradient(135deg, #ef4444 0%, #ec4899 100%);
            color: white;
            border-color: #ef4444;
        }
        
        .bingo-cell.drawn {
            background: linear-gradient(135deg, #fcd34d 0%, #fb923c 100%);
            border: 4px solid #f59e0b;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .alert {
            position: absolute;
            top: 0;
            right: 0;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .room-code {
            background: linear-gradient(135deg, #34d399 0%, #3b82f6 100%);
            border-radius: 12px;
            padding: 1.5rem;
            color: white;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .room-code-text {
            font-size: 2.5rem;
            font-weight: bold;
            letter-spacing: 0.2em;
            margin: 0.5rem 0;
        }
        
        .current-number {
            border-radius: 16px;
            padding: 3rem 2rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .current-number.active {
            background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
        }
        
        .current-number.inactive {
            background: #e5e7eb;
        }
        
        .current-number-label {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        .current-number.active .current-number-label { color: white; }
        .current-number.inactive .current-number-label { color: #6b7280; }
        
        .current-number-value {
            font-size: 5rem;
            font-weight: bold;
        }
        
        .current-number.active .current-number-value { color: white; }
        .current-number.inactive .current-number-value { color: #9ca3af; }
        
        .info-box {
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .info-blue { background: #dbeafe; border: 2px solid #3b82f6; color: #1e40af; }
        .info-green { background: #d1fae5; border: 2px solid #10b981; color: #065f46; }
        .info-yellow { background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; }
        
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .flex { display: flex; }
        .flex-gap { gap: 0.5rem; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .text-gray { color: #6b7280; }
        .font-bold { font-weight: bold; }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-number {
            background: #3b82f6;
            color: white;
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            font-weight: bold;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .header-title h1 { margin: 0; font-size: 1.5rem; }
        .header-subtitle { font-size: 0.875rem; color: #3b82f6; font-weight: 600; margin-top: 0.25rem; }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        @media (max-width: 640px) {
            .card, .card-game { padding: 1rem; }
            h1 { font-size: 1.5rem; }
            .bingo-cell { font-size: 1.25rem; }
            .current-number-value { font-size: 3.5rem; }
            .room-code-text { font-size: 2rem; }
            .history-grid { grid-template-columns: repeat(6, 1fr); }
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ç°¡æ˜“æœ¬åœ°å„²å­˜
        const storage = {
            get: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? { value: data } : null;
                } catch (e) {
                    return null;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                    return { value };
                } catch (e) {
                    return null;
                }
            }
        };

        class BingoGame {
            constructor() {
                this.state = {
                    mode: 'select',
                    drawnNumbers: [],
                    currentNumber: null,
                    playerBoard: [],
                    markedCells: [],
                    bingoLines: 0,
                    showHistory: false,
                    hostBoard: [],
                    hostMarkedCells: [],
                    hostBingoLines: 0,
                    showHostCard: false,
                    roomId: '',
                    playerName: '',
                    hostName: '',
                    inputPlayerName: '',
                    inputHostName: '',
                    inputRoomId: ''
                };
                this.render();
            }

            generateBoard() {
                const numbers = Array.from({ length: 53 }, (_, i) => i + 1);
                for (let i = numbers.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
                }
                const board = [];
                for (let i = 0; i < 6; i++) {
                    board.push(numbers.slice(i * 6, (i + 1) * 6));
                }
                return board;
            }

            generateRoomId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            calculateBingoLines(board, markedCells) {
                let lines = 0;
                const marked = new Set(markedCells);
                
                for (let i = 0; i < 6; i++) {
                    if (Array.from({ length: 6 }, (_, j) => `${i}-${j}`).every(c => marked.has(c))) lines++;
                }
                for (let j = 0; j < 6; j++) {
                    if (Array.from({ length: 6 }, (_, i) => `${i}-${j}`).every(c => marked.has(c))) lines++;
                }
                if (Array.from({ length: 6 }, (_, i) => `${i}-${i}`).every(c => marked.has(c))) lines++;
                if (Array.from({ length: 6 }, (_, i) => `${i}-${5 - i}`).every(c => marked.has(c))) lines++;
                
                return lines;
            }

            drawNumber() {
                const remaining = Array.from({ length: 53 }, (_, i) => i + 1)
                    .filter(num => !this.state.drawnNumbers.includes(num));
                if (remaining.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * remaining.length);
                const number = remaining[randomIndex];
                
                this.state.drawnNumbers.push(number);
                this.state.currentNumber = number;
                
                if (this.state.roomId) {
                    const data = {
                        drawnNumbers: this.state.drawnNumbers,
                        currentNumber: this.state.currentNumber,
                        timestamp: Date.now()
                    };
                    storage.set(`bingo_room_${this.state.roomId}`, JSON.stringify(data));
                }
                
                this.render();
            }

            markCell(rowIndex, colIndex, isHost = false) {
                const cellKey = `${rowIndex}-${colIndex}`;
                const board = isHost ? this.state.hostBoard : this.state.playerBoard;
                const markedCells = isHost ? this.state.hostMarkedCells : this.state.markedCells;
                
                const idx = markedCells.indexOf(cellKey);
                if (idx > -1) {
                    markedCells.splice(idx, 1);
                } else {
                    markedCells.push(cellKey);
                }
                
                if (isHost) {
                    this.state.hostBingoLines = this.calculateBingoLines(this.state.hostBoard, this.state.hostMarkedCells);
                } else {
                    this.state.bingoLines = this.calculateBingoLines(this.state.playerBoard, this.state.markedCells);
                }
                
                this.render();
            }

            resetGame() {
                this.state.drawnNumbers = [];
                this.state.currentNumber = null;
                
                if (this.state.mode === 'player') {
                    this.state.playerBoard = this.generateBoard();
                    this.state.markedCells = [];
                    this.state.bingoLines = 0;
                } else if (this.state.mode === 'host') {
                    this.state.hostBoard = this.generateBoard();
                    this.state.hostMarkedCells = [];
                    this.state.hostBingoLines = 0;
                    
                    if (this.state.roomId) {
                        storage.set(`bingo_room_${this.state.roomId}`, JSON.stringify({
                            drawnNumbers: [],
                            currentNumber: null,
                            timestamp: Date.now()
                        }));
                    }
                }
                
                this.render();
            }

            render() {
                const app = document.getElementById('app');
                app.innerHTML = '';
                
                if (this.state.mode === 'select') {
                    app.innerHTML = `
                        <div class="screen bg-purple">
                            <div class="card">
                                <h1>è³“æœéŠæˆ²</h1>
                                <div class="space-y-4">
                                    <button class="btn btn-blue" onclick="game.initHostMode()">
                                        ğŸ¯ ä¸»æŒäººæ¨¡å¼
                                    </button>
                                    <button class="btn btn-green" onclick="game.initPlayerMode()">
                                        ğŸ® ç©å®¶æ¨¡å¼
                                    </button>
                                </div>
                                <div class="info-box info-blue" style="margin-top: 1.5rem;">
                                    <p class="text-sm">ğŸ“± é©åˆé¤å»³å¤šäººéŠæˆ²</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (this.state.mode === 'host_name_input') {
                    app.innerHTML = `
                        <div class="screen bg-blue">
                            <div class="card">
                                <h1>ğŸ¯ ä¸»æŒäººè³‡è¨Š</h1>
                                <div class="form-group">
                                    <label class="label">è«‹è¼¸å…¥ä½ çš„åå­—</label>
                                    <input type="text" class="input" placeholder="ä¾‹å¦‚: å°æ˜" maxlength="10" 
                                           value="${this.state.inputHostName}"
                                           oninput="game.state.inputHostName = this.value; game.render()">
                                </div>
                                <button class="btn btn-blue mb-1" 
                                        onclick="game.startHostMode()"
                                        ${!this.state.inputHostName.trim() ? 'disabled' : ''}>
                                    é–‹å§‹éŠæˆ²
                                </button>
                                <button class="btn btn-gray" onclick="game.state.mode = 'select'; game.render()">
                                    è¿”å›
                                </button>
                            </div>
                        </div>
                    `;
                } else if (this.state.mode === 'host') {
                    this.renderHostMode(app);
                } else if (this.state.mode === 'player_login') {
                    app.innerHTML = `
                        <div class="screen bg-green">
                            <div class="card">
                                <h1>ğŸ® ç©å®¶ç™»å…¥</h1>
                                <div class="form-group">
                                    <label class="label">ä½ çš„åå­—</label>
                                    <input type="text" class="input" placeholder="ä¾‹å¦‚: å°è¯" maxlength="10"
                                           value="${this.state.inputPlayerName}"
                                           oninput="game.state.inputPlayerName = this.value; game.render()">
                                </div>
                                <button class="btn btn-green mb-1" 
                                        onclick="game.startPlayerMode()"
                                        ${!this.state.inputPlayerName.trim() ? 'disabled' : ''}>
                                    é–‹å§‹éŠæˆ²
                                </button>
                                <button class="btn btn-gray" onclick="game.state.mode = 'select'; game.render()">
                                    è¿”å›
                                </button>
                            </div>
                        </div>
                    `;
                } else if (this.state.mode === 'player') {
                    this.renderPlayerMode(app);
                }
            }

            renderHostMode(app) {
                const container = document.createElement('div');
                container.className = 'screen bg-blue';
                container.innerHTML = `
                    <div class="card-game">
                        <div class="header">
                            <div class="header-title">
                                <h1>ğŸ¯ ä¸»æŒäººæ§åˆ¶å°</h1>
                                <div class="header-subtitle">ä¸»æŒäºº: ${this.state.hostName}</div>
                            </div>
                            <button class="btn btn-gray btn-small" onclick="game.state.mode = 'select'; game.render()">è¿”å›</button>
                        </div>

                        <div class="room-code">
                            <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">æˆ¿é–“ä»£ç¢¼ï¼ˆåˆ†äº«çµ¦ç©å®¶ï¼‰</div>
                            <div class="room-code-text">${this.state.roomId}</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">ç©å®¶è¼¸å…¥æ­¤ä»£ç¢¼å³å¯åŠ å…¥éŠæˆ²</div>
                        </div>

                        <div class="current-number ${this.state.currentNumber ? 'active' : 'inactive'}">
                            <div class="current-number-label">${this.state.currentNumber ? 'ç•¶å‰è™Ÿç¢¼' : 'æº–å‚™é–‹å§‹æŠ½è™Ÿ'}</div>
                            ${this.state.currentNumber ? `<div class="current-number-value">${this.state.currentNumber}</div>` : ''}
                        </div>

                        <div class="flex flex-gap mb-2">
                            <button class="btn btn-green" onclick="game.drawNumber()" ${this.state.drawnNumbers.length === 53 ? 'disabled' : ''}>
                                â–¶ æŠ½è™Ÿç¢¼
                            </button>
                            <button class="btn btn-red" onclick="game.resetGame()">
                                â†» é‡ç½®
                            </button>
                        </div>

                        <div class="text-center mb-2 text-gray">
                            å·²æŠ½å‡º: ${this.state.drawnNumbers.length} / 53
                        </div>

                        <div class="info-box info-blue mb-2">
                            <div class="font-bold mb-1">å·²æŠ½å‡ºçš„è™Ÿç¢¼</div>
                            <div class="history-grid">
                                ${this.state.drawnNumbers.map(num => `<div class="history-number">${num}</div>`).join('')}
                            </div>
                        </div>

                        <button class="btn btn-purple mb-2" onclick="game.state.showHostCard = !game.state.showHostCard; game.render()">
                            ${this.state.showHostCard ? 'ğŸ‘ï¸ éš±è—æˆ‘çš„è³“æœå¡' : 'ğŸ‘ï¸ é¡¯ç¤ºæˆ‘çš„è³“æœå¡'}
                        </button>

                        ${this.state.showHostCard ? this.renderBingoCard(this.state.hostBoard, this.state.hostMarkedCells, true, this.state.hostBingoLines) : ''}
                    </div>
                `;
                app.appendChild(container);
            }

            renderPlayerMode(app) {
                const container = document.createElement('div');
                container.className = 'screen bg-green';
                container.innerHTML = `
                    <div class="card-game">
                        <div class="header">
                            <div class="header-title">
                                <h1>ğŸ® ${this.state.playerName} çš„è³“æœå¡</h1>
                            </div>
                            <button class="btn btn-gray btn-small" onclick="game.state.mode = 'select'; game.render()">é›¢é–‹</button>
                        </div>

                        <div class="text-center mb-2">
                            <div class="badge">ğŸ‰ é€£ç·šæ•¸: ${this.state.bingoLines}</div>
                        </div>

                        ${this.renderBingoCard(this.state.playerBoard, this.state.markedCells, false, this.state.bingoLines)}

                        <div class="flex flex-gap mb-2">
                            <button class="btn btn-purple" onclick="game.state.playerBoard = game.generateBoard(); game.state.markedCells = []; game.state.bingoLines = 0; game.render()">
                                ğŸ”€ é‡æ–°ç”Ÿæˆ
                            </button>
                            <button class="btn btn-orange" onclick="game.state.markedCells = []; game.state.bingoLines = 0; game.render()">
                                â†» æ¸…é™¤æ¨™è¨˜
                            </button>
                        </div>

                        <div class="info-box info-yellow">
                            <p class="text-sm">ğŸ’¡ æç¤ºï¼šè½ä¸»æŒäººå ±è™Ÿå¾Œï¼Œé»æ“Šå°æ‡‰è™Ÿç¢¼æ¨™è¨˜</p>
                        </div>
                    </div>
                `;
                app.appendChild(container);
            }

            renderBingoCard(board, markedCells, isHost, lines) {
                const markedSet = new Set(markedCells);
                const drawnSet = new Set(this.state.drawnNumbers);
                
                let html = `
                    <div class="info-box ${isHost ? 'info-green' : 'info-green'} mb-2">
                        <div class="font-bold">${isHost ? this.state.hostName + ' çš„é€£ç·šæ•¸' : 'é€£ç·šæ•¸'}: ${lines}</div>
                    </div>
                    <div class="bingo-grid">
                `;
                
                board.forEach((row, rowIndex) => {
                    row.forEach((num, colIndex) => {
                        const cellKey = `${rowIndex}-${colIndex}`;
                        const isMarked = markedSet.has(cellKey);
                        const isDrawn = drawnSet.has(num);
                        
                        let className = 'bingo-cell';
                        if (isMarked) className += ' marked';
                        else if (isDrawn) className += ' drawn';
                        
                        html += `
                            <div class="${className}" onclick="game.markCell(${rowIndex}, ${colIndex}, ${isHost})">
                                ${num}
                                ${isDrawn && !isMarked ? '<span class="alert">!</span>' : ''}
                            </div>
                        `;
                    });
                });
                
                html += '</div>';
                return html;
            }

            initHostMode() {
                this.state.mode = 'host_name_input';
                this.state.inputHostName = '';
                this.render();
            }

            initPlayerMode() {
                this.state.mode = 'player_login';
                this.state.inputPlayerName = '';
                this.render();
            }

            startHostMode() {
                if (!this.state.inputHostName.trim()) return;
                
                this.state.mode = 'host';
                this.state.hostName = this.state.inputHostName;
                this.state.roomId = this.generateRoomId();
                this.state.hostBoard = this.generateBoard();
                this.state.hostMarkedCells = [];
                this.state.hostBingoLines = 0;
                this.state.drawnNumbers = [];
                this.state.currentNumber = null;
                this.state.showHostCard = false;
                this.render();
            }

            startPlayerMode() {
                if (!this.state.inputPlayerName.trim()) return;
                
                this.state.mode = 'player';
                this.state.playerName = this.state.inputPlayerName;
                this.state.playerBoard = this.generateBoard();
                this.state.markedCells = [];
                this.state.bingoLines = 0;
                this.render();
            }
        }

        const game = new BingoGame();
    </script>
</body>
</html>