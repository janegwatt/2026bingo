<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æ·¨åŠ›å°¾ç‰™è³“æœ</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; overflow-x: hidden; background: #f3f4f6; }
        @keyframes pulse-custom { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .animate-pulse-slow { animation: pulse-custom 2s infinite; }
        .bingo-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; }
        @media (max-width: 380px) { .bingo-grid { gap: 4px; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const storage = {
            get: (key) => localStorage.getItem(key),
            set: (key, value) => localStorage.setItem(key, value)
        };

        function BingoGame() {
            const [mode, setMode] = useState('select');
            const [playerName, setPlayerName] = useState('');
            const [roomId, setRoomId] = useState('');
            const [inputRoomId, setInputRoomId] = useState('');
            const [isConnected, setIsConnected] = useState(false);
            
            // éŠæˆ²è³‡æ–™
            const [drawnNumbers, setDrawnNumbers] = useState([]);
            const [currentNumber, setCurrentNumber] = useState(null);
            const [playerBoard, setPlayerBoard] = useState([]);
            const [markedCells, setMarkedCells] = useState([]); // ç©å®¶è‡ªè¡Œè¨˜éŒ„çš„æ ¼å­è·¯å¾‘
            const [showHistory, setShowHistory] = useState(false);

            // æˆ¿é–“åŒæ­¥é‚è¼¯
            useEffect(() => {
                if (isConnected && roomId) {
                    const interval = setInterval(() => {
                        const data = storage.get(`bingo_room_${roomId}`);
                        if (data) {
                            const parsed = JSON.parse(data);
                            setDrawnNumbers(parsed.drawnNumbers || []);
                            setCurrentNumber(parsed.currentNumber || null);
                        }
                    }, 2000);
                    return () => clearInterval(interval);
                }
            }, [isConnected, roomId]);

            // åˆå§‹åŒ–ç©å®¶æ£‹ç›¤
            const initPlayer = () => {
                if (!playerName.trim()) return alert("è«‹è¼¸å…¥å§“å");
                const numbers = Array.from({ length: 53 }, (_, i) => i + 1).sort(() => Math.random() - 0.5);
                const board = [];
                for (let i = 0; i < 6; i++) board.push(numbers.slice(i * 6, (i + 1) * 6));
                setPlayerBoard(board);
                setMode('join_room');
            };

            // è¨ˆç®—é€£ç·š
            const bingoLines = useMemo(() => {
                let lines = 0;
                const marked = new Set(markedCells);
                // æ©«ç·š & ç›´ç·š
                for (let i = 0; i < 6; i++) {
                    if (Array.from({ length: 6 }, (_, j) => `${i}-${j}`).every(c => marked.has(c))) lines++;
                    if (Array.from({ length: 6 }, (_, j) => `${j}-${i}`).every(c => marked.has(c))) lines++;
                }
                // æ–œç·š
                if (Array.from({ length: 6 }, (_, i) => `${i}-${i}`).every(c => marked.has(c))) lines++;
                if (Array.from({ length: 6 }, (_, i) => `${i}-${5 - i}`).every(c => marked.has(c))) lines++;
                return lines;
            }, [markedCells]);

            const toggleMark = (r, c) => {
                const key = `${r}-${c}`;
                setMarkedCells(prev => prev.includes(key) ? prev.filter(i => i !== key) : [...prev, key]);
            };

            // --- è¦–åœ–ï¼šé¸æ“‡æ¨¡å¼ ---
            if (mode === 'select') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-indigo-600 to-purple-700">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center">
                            <h1 className="text-4xl font-black mb-8 text-gray-800 tracking-tighter">æ·¨åŠ›è³“æœ <span className="text-sm font-normal text-purple-500 block">2026 å°¾ç‰™ç‰ˆ</span></h1>
                            <div className="space-y-4">
                                <div className="text-left">
                                    <label className="text-xs font-bold text-gray-400 ml-1 uppercase">Your Name</label>
                                    <input type="text" placeholder="è«‹è¼¸å…¥å§“å" value={playerName} onChange={e => setPlayerName(e.target.value)} 
                                        className="w-full px-4 py-4 bg-gray-100 rounded-2xl border-2 border-transparent focus:border-purple-500 focus:bg-white outline-none transition-all text-lg font-bold" />
                                </div>
                                <button onClick={initPlayer} className="w-full bg-purple-600 hover:bg-purple-700 text-white font-black py-4 rounded-2xl shadow-lg shadow-purple-200 transition-all active:scale-95 text-xl">
                                    é€²å…¥éŠæˆ² ğŸ®
                                </button>
                                <button onClick={() => setMode('host')} className="w-full text-purple-600 font-bold py-2 opacity-60 hover:opacity-100 transition-opacity">
                                    åˆ‡æ›ä¸»æŒäººæ¨¡å¼ ğŸ¯
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- è¦–åœ–ï¼šä¸»æŒäººæ¨¡å¼ ---
            if (mode === 'host') {
                const draw = () => {
                    const pool = Array.from({ length: 53 }, (_, i) => i + 1).filter(n => !drawnNumbers.includes(n));
                    if (pool.length === 0) return;
                    const num = pool[Math.floor(Math.random() * pool.length)];
                    const next = [...drawnNumbers, num];
                    setDrawnNumbers(next);
                    setCurrentNumber(num);
                    if (roomId) storage.set(`bingo_room_${roomId}`, JSON.stringify({ drawnNumbers: next, currentNumber: num }));
                };

                return (
                    <div className="min-h-screen bg-gray-900 text-white p-4">
                        <div className="max-w-md mx-auto">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold">ğŸ¯ ä¸»æŒé–‹çæ©Ÿ</h2>
                                <button onClick={() => window.location.reload()} className="text-gray-400">é€€å‡º</button>
                            </div>
                            
                            {!roomId ? (
                                <button onClick={() => setRoomId(Math.random().toString(36).substring(2,8).toUpperCase())} className="w-full bg-blue-600 py-4 rounded-xl font-bold">å»ºç«‹é–‹çæˆ¿é–“</button>
                            ) : (
                                <div className="bg-gray-800 p-6 rounded-3xl text-center border border-gray-700 shadow-xl">
                                    <div className="text-sm text-gray-400 mb-1">æˆ¿é–“ä»£ç¢¼</div>
                                    <div className="text-4xl font-black text-blue-400 tracking-widest mb-4">{roomId}</div>
                                    <div className="bg-black/50 py-10 rounded-2xl mb-6">
                                        <div className="text-xs text-gray-500 uppercase mb-2 font-bold">Now Drawing</div>
                                        <div className="text-8xl font-black text-white">{currentNumber || '--'}</div>
                                    </div>
                                    <button onClick={draw} className="w-full bg-gradient-to-r from-blue-500 to-indigo-600 py-5 rounded-2xl font-black text-2xl shadow-lg active:scale-95 transition-all">
                                        æŠ½å‡ºä¸‹ä¸€å€‹è™Ÿç¢¼
                                    </button>
                                </div>
                            )}
                            <div className="mt-6">
                                <p className="text-sm font-bold text-gray-500 mb-2">å·²æŠ½å‡º ({drawnNumbers.length}/53)</p>
                                <div className="flex flex-wrap gap-2">
                                    {drawnNumbers.slice().reverse().map(n => <span key={n} className="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center font-bold border border-gray-600">{n}</span>)}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- è¦–åœ–ï¼šåŠ å…¥æˆ¿é–“ ---
            if (mode === 'join_room') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-gray-50">
                        <div className="bg-white rounded-3xl shadow-xl p-8 w-full max-w-sm border border-gray-100">
                            <h2 className="text-2xl font-black mb-2">ä½ å¥½, {playerName}! ğŸ‘‹</h2>
                            <p className="text-gray-500 text-sm mb-6">è«‹è¼¸å…¥ä¸»æŒäººæä¾›çš„æˆ¿é–“ä»£ç¢¼ä»¥åŒæ­¥é–‹çé€²åº¦ï¼Œæˆ–ç›´æ¥é–‹å§‹éŠæˆ²ã€‚</p>
                            <input type="text" placeholder="ROOM CODE" value={inputRoomId} onChange={e => setInputRoomId(e.target.value.toUpperCase())}
                                className="w-full px-4 py-4 bg-gray-100 rounded-2xl mb-4 text-center text-2xl font-black tracking-widest outline-none border-2 border-transparent focus:border-green-500" />
                            <div className="space-y-3">
                                <button onClick={() => { setRoomId(inputRoomId); setIsConnected(true); setMode('player'); }} className="w-full bg-green-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-green-100">åŠ å…¥åŒæ­¥æˆ¿é–“</button>
                                <button onClick={() => setMode('player')} className="w-full bg-white text-gray-400 font-bold py-3">æš«ä¸åŠ å…¥ï¼Œç›´æ¥é–‹å§‹</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- è¦–åœ–ï¼šç©å®¶è³“æœå¡ ---
            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <div className="bg-white p-4 sticky top-0 z-10 shadow-sm flex justify-between items-end">
                        <div>
                            <div className="flex items-center gap-2">
                                <span className="text-xs font-black bg-purple-100 text-purple-600 px-2 py-0.5 rounded-md uppercase tracking-tighter">Player</span>
                                <h2 className="font-bold text-gray-800">{playerName}</h2>
                            </div>
                            <div className="text-[10px] text-gray-400 mt-1 font-medium italic">
                                {isConnected ? `å·²åŒæ­¥æˆ¿é–“: ${roomId}` : "æœªé€£ç·š - æ‰‹å‹•æ¨¡å¼"}
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-3xl font-black text-purple-600 leading-none">{bingoLines}</div>
                            <div className="text-[10px] font-bold text-gray-400 uppercase">Lines</div>
                        </div>
                    </div>

                    {/* Current Number Banner */}
                    {isConnected && currentNumber && (
                        <div className="bg-gradient-to-r from-orange-400 to-pink-500 p-3 text-white flex items-center justify-between px-6 shadow-inner">
                            <span className="text-sm font-bold opacity-80 uppercase tracking-widest">æœ€æ–°é–‹ç</span>
                            <span className="text-4xl font-black drop-shadow-md">{currentNumber}</span>
                        </div>
                    )}

                    {/* Bingo Grid */}
                    <div className="p-3 mt-2">
                        <div className="bingo-grid">
                            {playerBoard.map((row, rIdx) => row.map((num, cIdx) => {
                                const key = `${rIdx}-${cIdx}`;
                                const isMarked = markedCells.includes(key);
                                const isDrawn = drawnNumbers.includes(num);
                                return (
                                    <button key={key} onClick={() => toggleMark(rIdx, cIdx)}
                                        className={`aspect-square rounded-xl text-xl font-black transition-all relative border-b-4 active:border-b-0 active:translate-y-1
                                        ${isMarked 
                                            ? 'bg-gradient-to-br from-red-400 to-pink-500 text-white border-red-600 shadow-lg shadow-red-100' 
                                            : isDrawn 
                                                ? 'bg-yellow-50 text-orange-500 border-yellow-200 animate-pulse-slow' 
                                                : 'bg-white text-gray-700 border-gray-200'}`}>
                                        {num}
                                        {isDrawn && !isMarked && (
                                            <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] flex items-center justify-center rounded-full border-2 border-white font-black animate-bounce">!</span>
                                        )}
                                    </button>
                                );
                            }))}
                        </div>
                    </div>

                    {/* History */}
                    <div className="px-4 mt-6">
                        <button onClick={() => setShowHistory(!showHistory)} className="w-full py-3 bg-gray-100 rounded-xl text-gray-500 font-bold text-sm uppercase tracking-widest">
                            {showHistory ? "éš±è—é–‹çç´€éŒ„" : "æŸ¥çœ‹é–‹çç´€éŒ„"}
                        </button>
                        {showHistory && (
                            <div className="flex flex-wrap gap-2 mt-4 p-4 bg-white rounded-2xl">
                                {drawnNumbers.length > 0 ? drawnNumbers.map(n => (
                                    <span key={n} className="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-xs">{n}</span>
                                )) : <p className="text-gray-400 text-xs w-full text-center py-4">ç›®å‰å°šç„¡é–‹çè³‡æ–™</p>}
                            </div>
                        )}
                    </div>

                    <p className="text-center text-[10px] text-gray-300 mt-10 mb-10 px-10">
                        é»æ“Šæ ¼å­æ¨™è¨˜æ‚¨çš„è™Ÿç¢¼ã€‚è™Ÿç¢¼é¡¯ç¤ºé»ƒè‰²é–ƒçˆè¡¨ç¤ºè©²è™Ÿç¢¼ä¸»æŒäººå·²æŠ½å‡ºã€‚
                    </p>
                </div>
            );
        }

        ReactDOM.render(<BingoGame />, document.getElementById('root'));
    </script>
</body>
</html>
